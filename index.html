<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CheckWin - Estrategia & Premios</title>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS GENERALES Y VARIABLES --- */
        :root {
            --primary: #58cc02; 
            --primary-dark: #46a302;
            --secondary: #1cb0f6;
            --danger: #ff4b4b;
            --energy: #2ecc71; 
            --gold: #ffc800;
            --elo: #9b59b6; 
            --process: #e67e22; 
            --dark: #2c3e50;
            --light: #f7f7f7;
            --claro: #da291c;
            --tigo: #00377d;
            --premove: #ff527b; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Nunito', 'Segoe UI', sans-serif; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.2s ease;
        }

        /* --- LOGO CHECKWIN --- */
        .app-logo {
            font-family: 'Verdana', sans-serif;
            font-weight: 900;
            font-size: 2.5rem;
            letter-spacing: -1px;
            background: -webkit-linear-gradient(45deg, var(--dark), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 5px;
            display: inline-block;
        }

        .app-logo span {
            color: var(--primary);
            -webkit-text-fill-color: var(--primary);
        }

        /* --- HEADER --- */
        header {
            background: white;
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e5e5e5;
            z-index: 100;
            font-size: 0.85rem;
            overflow-x: auto; 
        }

        .status-group { display: flex; gap: 5px; align-items: center; }
        
        .stat-badge { 
            display: flex; 
            align-items: center; 
            font-weight: 800; 
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            white-space: nowrap;
            transition: all 0.5s ease;
        }
        
        .stat-badge i { margin-right: 4px; }
        
        .hearts { color: var(--danger); cursor: pointer; min-width: 60px; justify-content: center; }
        
        .hearts.pro-active {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white;
            box-shadow: 0 2px 5px rgba(155, 89, 182, 0.4);
        }

        .energy-badge { color: var(--energy); cursor: pointer; }
        .elo-badge { color: var(--elo); cursor: pointer; border: 1px solid #eee; }
        
        .ref-badge { color: white; background: var(--secondary); cursor: pointer; box-shadow: 0 2px 0 #158dbf; }
        .ref-badge:active { transform: translateY(1px); box-shadow: none; }

        .process-badge { 
            color: var(--process); 
            background: #fff3cd; 
            border: 1px solid #ffeeba; 
            cursor: pointer; 
            display: none; 
        }

        .success-glow {
            background-color: #d4edda !important; 
            color: #155724 !important; 
            border-color: #c3e6cb !important;
            box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .coins { color: var(--gold); }

        /* --- CONTENEDOR PRINCIPAL --- */
        #app-container { 
            flex: 1; 
            position: relative; 
            overflow-y: auto; 
            padding: 20px; 
        }

        .screen { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            animation: fadeIn 0.3s ease; 
            width: 100%; 
        }
        .screen.active { display: flex; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- AJEDREZ STYLES --- */
        #myBoard {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border: 5px solid #333;
            border-radius: 4px;
            touch-action: manipulation; 
        }
        
        .highlight-square {
            box-shadow: inset 0 0 3px 3px yellow;
            background-color: rgba(255, 255, 0, 0.5);
        }

        .premove-square {
            box-shadow: inset 0 0 3px 3px var(--premove);
            background-color: rgba(255, 82, 123, 0.4);
        }

        .game-top-bar {
            width: 100%;
            max-width: 400px;
            display: flex;
            justify-content: flex-start;
            margin-bottom: 10px;
        }

        #btn-game-stats {
            background: #fff;
            border: 2px solid #eee;
            color: var(--secondary);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
            display: block; 
        }
        
        #btn-game-stats.disabled {
            background: #f5f5f5;
            color: #ccc;
            border-color: #eee;
            pointer-events: none; 
            box-shadow: none;
        }

        #btn-game-stats:active { transform: scale(0.95); }

        .game-header { 
            width: 100%; 
            max-width: 400px; 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 5px; 
            align-items: flex-end; 
        }
        
        .timer-box { 
            background: #333; 
            color: white; 
            padding: 5px 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 1.2rem; 
            font-weight: bold; 
            min-width: 80px; 
            text-align: center; 
        }
        .timer-box.active { 
            background: var(--danger); 
            box-shadow: 0 0 10px var(--danger); 
            animation: pulse 1s infinite; 
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .player-info { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            font-size: 0.9rem; 
            font-weight: bold; 
        }
        
        .turn-dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            display: inline-block; 
            background: #ccc; 
        }
        .turn-dot.active { background: var(--primary); box-shadow: 0 0 5px var(--primary); }

        /* --- CONTROLES DE AN√ÅLISIS --- */
        #review-panel {
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
            display: none; 
            flex-direction: column;
            gap: 10px;
        }

        .review-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 4px 0 #eee;
        }

        .review-btn {
            background: var(--secondary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 3px 0 #158dbf;
        }
        .review-btn:active { transform: translateY(3px); box-shadow: none; }
        .review-btn.play { background: var(--primary); box-shadow: 0 3px 0 var(--primary-dark); }

        #move-history-container {
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #eee;
            max-height: 120px; 
            overflow-y: auto;
            text-align: left;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 5px;
            font-size: 0.9rem;
        }

        .move-number {
            color: #999;
            font-weight: normal;
            margin-right: 2px;
            margin-left: 5px;
            font-family: monospace;
        }
        
        .move-item {
            background: #f0f0f0;
            padding: 3px 6px;
            border-radius: 5px;
            cursor: default;
            transition: all 0.2s;
            font-weight: bold;
            color: #333;
        }

        .move-item.active-move {
            background: var(--gold);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid #e67e22;
        }

        /* --- TIENDA RECARGAS --- */
        .store-header { text-align: center; margin-bottom: 20px; }
        .provider-switch { display: flex; background: #eee; border-radius: 15px; padding: 5px; margin-bottom: 15px; width: 100%; }
        .prov-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 12px; font-weight: bold; color: #777; font-size: 1.1rem; transition: all 0.3s; }
        .prov-btn.active.claro { background: var(--claro); color: white; box-shadow: 0 4px 0 #a01b12; }
        .prov-btn.active.tigo { background: var(--tigo); color: white; box-shadow: 0 4px 0 #00224d; }
        .category-switch { display: flex; background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 5px; margin-bottom: 20px; width: 100%; overflow-x: auto; white-space: nowrap; }
        .cat-btn { border: none; background: transparent; padding: 8px 15px; border-radius: 10px; font-weight: bold; color: #777; margin-right: 5px; font-size: 0.9rem; flex-shrink: 0; }
        .cat-btn.active { background: #eee; color: var(--dark); }
        .product-item { background: white; width: 100%; margin-bottom: 15px; padding: 15px; border-radius: 16px; border: 2px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 0 #eee; transition: transform 0.2s; }
        .product-item.claro-style { border-color: #ffebee; }
        .product-item.tigo-style { border-color: #e3f2fd; }
        .product-details { flex: 1; padding-right: 10px; }
        .product-details h4 { margin-bottom: 4px; color: var(--dark); font-size: 1rem;}
        .product-details small { color: #666; display: block; font-size: 0.8rem; line-height: 1.3; }
        .product-price { text-align: right; line-height: 1.2; margin-bottom: 5px; }
        .price-real-tachado { font-size: 0.8rem; color: var(--danger); text-decoration: line-through; display: block; }
        .price-game-monedas { font-size: 1.1rem; font-weight: bold; color: var(--gold); }
        .buy-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 12px; font-weight: bold; box-shadow: 0 4px 0 var(--primary-dark); }
        .buy-btn:active { transform: translateY(4px); box-shadow: none; }
        .buy-btn:disabled { background: #aaa; box-shadow: none; opacity: 0.6; transform: none; }
        
        .recommended-badge {
            background: var(--gold);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 3px;
        }

        /* --- MODALES Y NAV --- */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1000; justify-content: center; align-items: flex-end; }
        .modal-sheet { background: white; width: 100%; max-width: 500px; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 25px; text-align: center; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-center { justify-content: center; align-items: center; }
        .modal-box { background: white; width: 95%; max-width: 400px; border-radius: 20px; padding: 20px; text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 90vh; overflow-y: auto; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .life-option { border: 2px solid #eee; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; position: relative; }
        .life-option.disabled { opacity: 0.5; pointer-events: none; }
        
        .config-row { display: flex; gap: 5px; margin-bottom: 15px; text-align: left; }
        .config-opt { flex: 1; padding: 8px 4px; border: 2px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; font-size: 0.85rem; }
        .config-opt.selected { border-color: var(--secondary); background: #e3f2fd; color: var(--secondary); font-weight: bold; }
        .config-label { font-size: 0.9rem; color: #777; margin-bottom: 5px; text-align: left; display: block; font-weight: bold; }
        .diff-reward { display: block; font-size: 0.7rem; color: #aaa; margin-top: 2px; }
        .config-opt.selected .diff-reward { color: var(--secondary); font-weight: normal; }

        .life-option.premium { border: 2px solid #9b59b6; background: linear-gradient(to right, #f3e5f5, white); transition: all 0.3s; }
        .offer-badge { position: absolute; top: -10px; right: 10px; background: #ff4757; color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: bounce 1s infinite; }
        .gift-icon { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 2.5rem; color: #ffcc00; text-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

        .btn-full { width: 100%; padding: 15px; border: none; border-radius: 15px; font-size: 1.1rem; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-close { background: #eee; color: #777; }
        .btn-action { background: var(--secondary); color: white; box-shadow: 0 4px 0 #158dbf; }
        .btn-whatsapp { background: #25D366; color: white; box-shadow: 0 4px 0 #128C7E; }
        .btn-whatsapp:active { transform: translateY(4px); box-shadow: none; }
        .btn-danger { background: white; color: var(--danger); border: 2px solid var(--danger); margin-top: 5px;}
        
        .code-input-container { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: none; }
        .code-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; text-align: center; font-size: 1.1rem; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 2px; }

        .ref-box { background: #f0f8ff; border: 2px dashed var(--secondary); padding: 15px; border-radius: 10px; margin-bottom: 15px; cursor: pointer; }
        .ref-code-display { font-size: 1.5rem; font-weight: 800; letter-spacing: 2px; color: var(--dark); margin: 5px 0; }
        
        nav { background: white; border-top: 2px solid #e5e5e5; display: flex; justify-content: space-around; padding: 10px 0; }
        .nav-item { text-align: center; color: #afafaf; font-size: 0.8rem; }
        .nav-item i { display: block; font-size: 1.5rem; margin-bottom: 3px; }
        .nav-item.active { color: var(--secondary); }
        
        .regen-timer { font-size: 0.7rem; color: #777; margin-left: 3px; font-weight: normal; }

        .stats-container { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; width: 100%; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; }
        .stat-row:last-child { margin-bottom: 0; }

        #custom-alert, #custom-confirm { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1500; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .alert-box { background: white; border-radius: 15px; padding: 25px; width: 80%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s ease; }
        #custom-alert.show, #custom-confirm.show { opacity: 1; }
        #custom-alert.show .alert-box, #custom-confirm.show .alert-box { transform: scale(1); }
        .alert-icon { font-size: 3rem; margin-bottom: 10px; }
        /* --- SPLASH SCREEN STYLES --- */
#splash-screen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(180deg, #58cc02, #1cb0f6);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease, visibility 0.5s ease;
}

.splash-img {
    width: 150px; /* Ajusta seg√∫n tu imagen */
    height: auto;
    margin-bottom: 20px;
    animation: float 3s ease-in-out infinite;
}

.loader-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-top: 30px;
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

/* Clase para ocultar el splash */
.hide-splash {
    opacity: 0;
    visibility: hidden;
}
/* --- COVERFLOW 3D STYLE --- */
#products-list {
    position: relative;
    width: 100%;
    height: 420px; /* Altura del escenario */
    perspective: 1000px; /* Profundidad 3D */
    overflow: hidden;
    margin-top: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.coverflow-card {
    position: absolute;
    width: 260px;
    height: 360px;
    background: white;
    border-radius: 20px;
    border: 4px solid white; /* Borde blanco estilo carta */
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s, z-index 0s;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 20px;
    text-align: center;
    backface-visibility: hidden; /* Oculta la parte trasera para rendimiento */
}

/* Estilos internos de la tarjeta */
.cf-header {
    font-size: 1.2rem;
    font-weight: 800;
    margin-bottom: 10px;
    color: var(--dark);
    line-height: 1.2;
}

.cf-icon {
    font-size: 4rem;
    margin: 10px 0;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
}

.cf-desc {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 10px;
}

.cf-price-box {
    background: #f0f0f0;
    padding: 10px;
    border-radius: 12px;
    margin-bottom: 10px;
}

.cf-real-price {
    text-decoration: line-through;
    color: var(--danger);
    font-size: 0.9rem;
    display: block;
}

.cf-game-price {
    color: var(--gold);
    font-weight: 900;
    font-size: 1.4rem;
    text-shadow: 0 1px 1px rgba(0,0,0,0.1);
}

/* Colores seg√∫n proveedor */
.claro-card { border-color: var(--claro); }
.claro-card .cf-icon { color: var(--claro); }
.tigo-card { border-color: var(--tigo); }
.tigo-card .cf-icon { color: var(--tigo); }

/* --- ESTADOS 3D --- */

/* Tarjeta Central (Activa) */
.cf-center {
    transform: translateX(0) translateZ(0) rotateY(0deg);
    z-index: 100;
    opacity: 1;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
}

/* Tarjetas a la Izquierda */
.cf-left {
    transform: translateX(-180px) translateZ(-200px) rotateY(60deg);
    z-index: 50;
    opacity: 0.6;
    filter: brightness(0.8);
    pointer-events: auto; /* <--- CAMBIO IMPORTANTE: Antes dec√≠a 'none' */
    cursor: pointer;      /* Para que se vea que es cliqueable */
}
.cf-left-far {
    transform: translateX(-300px) translateZ(-400px) rotateY(70deg);
    z-index: 10;
    opacity: 0;
}

/* Tarjetas a la Derecha */
.cf-right {
    transform: translateX(180px) translateZ(-200px) rotateY(-60deg);
    z-index: 50;
    opacity: 0.6;
    filter: brightness(0.8);
    pointer-events: auto; /* <--- CAMBIO IMPORTANTE: Antes dec√≠a 'none' */
    cursor: pointer;
}
.cf-right-far {
    transform: translateX(300px) translateZ(-400px) rotateY(-70deg);
    z-index: 10;
    opacity: 0;
}
/* --- Agrega esto a tu CSS existente --- */

#products-list {
    /* Aseg√∫rate de que esta l√≠nea est√© en las reglas de #products-list */
    transition: opacity 0.3s ease-in-out;
}

/* Nueva clase para el estado de "desvanecido" */
#products-list.fade-out {
    opacity: 0;
}

    </style>
</head>
<body>
<div id="splash-screen">
<img id="portada-img" 
     src="https://raw.githubusercontent.com/LJonatan78/CheckWin.html/main/1770870844485-ezgif.com-resize.jpg" 
     alt="CheckWin Portada" 
     class="splash-img"
     style="border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
    <div class="app-logo" style="font-size: 3rem; margin-top: 20px; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.2);">
        Check<span style="color: #ffc800;">Win</span>
    </div>
    
    <div class="loader-spinner" style="border-top-color: white; border-left-color: rgba(255,255,255,0.3); border-bottom-color: rgba(255,255,255,0.3); border-right-color: rgba(255,255,255,0.3);"></div>
</div>

    <header>
        <div class="status-group">
            <div class="stat-badge hearts" onclick="SoundEngine.click(); openLifeShop()">
                <i id="life-icon" class="fas fa-heart"></i>
                <span id="lives-count">5</span>
                <span id="life-timer" class="regen-timer"></span>
            </div>
            
            <div class="stat-badge energy-badge" onclick="SoundEngine.click(); customAlert('Energ√≠a', 'Se usa para jugar. Costo: 10/partida. Se recarga sola.')">
                <i class="fas fa-bolt"></i>
                <span id="energy-count">50</span>
                <span id="energy-timer" class="regen-timer"></span>
            </div>

            <div class="stat-badge elo-badge" onclick="SoundEngine.click(); customAlert('Ranking ELO', 'Mide tu nivel de habilidad. Gana partidas dif√≠ciles para subir.')">
                <i class="fas fa-trophy"></i>
                <span id="elo-count">1200</span>
            </div>

            <div class="stat-badge ref-badge" onclick="SoundEngine.click(); openReferralModal()">
                <i class="fas fa-user-plus"></i>
                <span id="header-ref-id">INVITAR</span>
            </div>
            
            <div id="pending-badge" class="stat-badge process-badge">
                <i class="fas fa-clock fa-spin"></i>
            </div>
        </div>

        <div class="stat-badge coins">
            <i class="fas fa-coins"></i>
            <span id="coins-count">0</span>
        </div>
    </header>

    <div id="app-container">
        
        <div id="home-screen" class="screen active">
            <div style="margin-top: 30px; margin-bottom: 20px; text-align: center;">
                <div class="app-logo">Check<span>Win</span></div>
                <p style="color: #777; font-size: 0.9rem; margin-top: -5px;">Juega, Domina, Gana.</p>
            </div>
            
            <div style="background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; text-align: center; border: 1px solid #f0f0f0;">
                
                <div style="position: relative; display: inline-block;">
                    <i class="fas fa-chess-king" style="font-size: 4.5rem; color: var(--dark); margin-bottom: 15px;"></i>
                    <i class="fas fa-coins" style="position: absolute; bottom: 10px; right: -10px; font-size: 1.5rem; color: var(--gold); background: white; border-radius: 50%; padding: 2px;"></i>
                </div>

                <h3 style="margin-bottom: 5px; font-size: 1.4rem;">Partida Cl√°sica</h3>
                <p style="font-size: 0.9rem; color: #999; margin-bottom: 20px;">Vence a la IA y gana monedas</p>
                
                <div style="display:flex; justify-content:center; gap: 15px; margin-bottom: 20px;">
                    <div style="background:#f9f9f9; padding:8px 15px; border-radius:12px; font-size:0.8rem; font-weight:bold; color:var(--energy);">
                        <i class="fas fa-bolt"></i> -10 Energ√≠a
                    </div>
                    <div style="background:#fff8e1; padding:8px 15px; border-radius:12px; font-size:0.8rem; font-weight:bold; color:var(--gold);">
                        <i class="fas fa-trophy"></i> Gana hasta +40
                    </div>
                </div>

                <button class="btn-full btn-action" style="box-shadow: 0 8px 15px rgba(28, 176, 246, 0.3);" onclick="SoundEngine.click(); openSetupModal()">
                    JUGAR AHORA <i class="fas fa-play" style="margin-left:5px; font-size:0.8rem;"></i>
                </button>
            </div>

            <div style="margin-top: 25px; width: 100%; display: flex; gap: 10px;">
                <div style="flex: 1; background: #fff; padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);" onclick="SoundEngine.click(); navTo('store-screen', document.querySelectorAll('.nav-item')[1]); loadStore();">
                    <i class="fas fa-gift" style="font-size: 1.5rem; color: var(--premove); margin-bottom: 5px;"></i>
                    <div style="font-size: 0.8rem; font-weight: bold;">Premios</div>
                </div>
                <div style="flex: 1; background: #fff; padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03);" onclick="SoundEngine.click(); openReferralModal()">
                    <i class="fas fa-users" style="font-size: 1.5rem; color: var(--process); margin-bottom: 5px;"></i>
                    <div style="font-size: 0.8rem; font-weight: bold;">Amigos</div>
                </div>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div class="game-top-bar">
                <button id="btn-game-stats" class="disabled" onclick="SoundEngine.click(); showGameOverModal()">
                    <i class="fas fa-chevron-left"></i> Resultados
                </button>
            </div>

            <div class="game-header">
                <div class="player-info">
                    <span id="ai-dot" class="turn-dot"></span> IA (<span id="ai-level-txt">F√°cil</span>)
                </div>
                <div id="ai-timer" class="timer-box">00:00</div>
            </div>

            <div id="myBoard"></div>
            
            <div class="game-header" style="margin-top: 5px; margin-bottom: 0; align-items: flex-start;">
                <div class="player-info">
                    <span id="player-dot" class="turn-dot"></span> T√∫
                </div>
                <div id="player-timer" class="timer-box">00:00</div>
            </div>
            
            <p id="game-status-text" style="margin-top:15px; color:#777; min-height:20px; text-align:center; font-weight:bold;">Esperando...</p>
            
            <button id="surrender-btn" class="btn-full" style="background:#ddd; color:#555; margin-top:20px;" onclick="SoundEngine.click(); quitGame()">Rendirse</button>
            
            <div id="review-panel">
                <div class="review-controls">
                    <button class="review-btn" onclick="SoundEngine.click(); reviewStart()"><i class="fas fa-fast-backward"></i></button>
                    <button class="review-btn" onclick="SoundEngine.click(); reviewBack()"><i class="fas fa-step-backward"></i></button>
                    <button class="review-btn play" onclick="SoundEngine.click(); togglePlay()"><i id="play-icon" class="fas fa-play"></i></button>
                    <button class="review-btn" onclick="SoundEngine.click(); reviewForward()"><i class="fas fa-step-forward"></i></button>
                    <button class="review-btn" onclick="SoundEngine.click(); reviewEnd()"><i class="fas fa-fast-forward"></i></button>
                </div>
                <div id="move-history-container">
                    </div>
            </div>

        </div>

        <div id="store-screen" class="screen">
            <h2 class="store-header">Tienda de Recargas</h2>
            <input type="number" id="phone-input" placeholder="N√∫mero de celular (8 d√≠gitos)" 
                   style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 12px; margin-bottom: 15px; font-size: 1rem; text-align: center;">
            <div class="provider-switch">
                <button class="prov-btn active claro" onclick="SoundEngine.click(); switchProvider('claro', this)">Claro</button>
                <button class="prov-btn" onclick="SoundEngine.click(); switchProvider('tigo', this)">Tigo</button>
            </div>
            <div class="category-switch" id="category-switch"></div>
            <div id="products-list"></div>
        </div>
    </div>

    <div id="setup-modal" class="overlay modal-center">
        <div class="modal-box" style="text-align: left;">
            <h2 style="margin-bottom:20px; text-align:center;">Configurar Partida</h2>
            
            <div style="text-align:center; margin-bottom:15px; color:var(--energy); font-weight:bold;">
                <i class="fas fa-bolt"></i> Costo: 10 Energ√≠a
            </div>

            <span class="config-label">DIFICULTAD</span>
            <div class="config-row">
                <div class="config-opt selected" id="opt-diff-easy" onclick="SoundEngine.click(); selectOpt('diff','easy')">üê£ F√°cil<span class="diff-reward">Base: 10</span></div>
                <div class="config-opt" id="opt-diff-med" onclick="SoundEngine.click(); selectOpt('diff','med')">‚öñÔ∏è Medio<span class="diff-reward">Base: 20</span></div>
                <div class="config-opt" id="opt-diff-hard" onclick="SoundEngine.click(); selectOpt('diff','hard')">ü§ñ Pro<span class="diff-reward">Base: 40</span></div>
            </div>

            <span class="config-label">JUGAR CON</span>
            <div class="config-row">
                <div class="config-opt selected" id="opt-color-white" onclick="SoundEngine.click(); selectOpt('color','white')">üëë Blancas</div>
                <div class="config-opt" id="opt-color-black" onclick="SoundEngine.click(); selectOpt('color','black')">‚ôüÔ∏è Negras</div>
            </div>

            <span class="config-label">TIEMPO (Multiplicador de Premio)</span>
            <div class="config-row">
                <div class="config-opt" id="opt-time-1" onclick="SoundEngine.click(); selectOpt('time',1)">‚ö° 1m<span class="diff-reward">Premio x2.0</span></div>
                <div class="config-opt" id="opt-time-5" onclick="SoundEngine.click(); selectOpt('time',5)">5m<span class="diff-reward">Premio x1.5</span></div>
                <div class="config-opt selected" id="opt-time-10" onclick="SoundEngine.click(); selectOpt('time',10)">10m<span class="diff-reward">Premio x1.0</span></div>
                <div class="config-opt" id="opt-time-30" onclick="SoundEngine.click(); selectOpt('time',30)">30m<span class="diff-reward">Premio x0.5</span></div>
            </div>

            <button class="btn-full" style="background:var(--secondary); color:white;" onclick="SoundEngine.click(); launchGame()">COMENZAR</button>
            <button style="width:100%; margin-top:10px; padding:10px; background:none; border:none; color:#777; cursor:pointer;" onclick="SoundEngine.click(); closeSetupModal()">Cancelar</button>
        </div>
    </div>

    <div id="game-over-modal" class="overlay modal-center" onclick="closeGameOverModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <i id="go-icon" class="fas fa-trophy" style="font-size: 4rem; margin-bottom: 10px;"></i>
            <h2 id="go-title" style="margin-bottom: 5px;">¬°VICTORIA!</h2>
            <p id="go-msg" style="color: #777; margin-bottom: 20px;">Has ganado la partida.</p>
            
            <div class="stats-container">
                <div class="stat-row">
                    <span><i class="fas fa-coins" style="color: var(--gold);"></i> Monedas</span>
                    <span id="go-coins" style="font-weight: bold;">+0</span>
                </div>
                <div class="stat-row">
                    <span><i class="fas fa-trophy" style="color: var(--elo);"></i> ELO (Ranking)</span>
                    <span id="go-elo" style="font-weight: bold;">+0</span>
                </div>
                <div class="stat-row">
                    <span><i class="fas fa-heart" style="color: var(--danger);"></i> Vidas</span>
                    <span id="go-lives" style="font-weight: bold;">-0</span>
                </div>
                <div class="stat-row">
                    <span><i class="fas fa-bolt" style="color: var(--energy);"></i> Energ√≠a</span>
                    <span id="go-energy" style="font-weight: bold;">-0</span>
                </div>
            </div>

            <button class="btn-full btn-action" onclick="SoundEngine.click(); rematch()">üîÑ REVANCHA (-10 Energ√≠a)</button>
            <button class="btn-full" style="background: #eee; color: #555;" onclick="SoundEngine.click(); goToMenu()">üè† MEN√ö</button>
        </div>
    </div>

    <div id="life-modal" class="overlay">
        <div class="modal-sheet">
            <i class="fas fa-heart-crack" style="font-size: 3rem; color: var(--danger); margin-bottom: 15px;" id="modal-icon"></i>
            <h2 style="margin-bottom: 10px;">Gestionar Vidas</h2>
            <div id="normal-options">
                <div class="life-option" id="ad-option" onclick="SoundEngine.click(); watchAd()">
                    <div style="text-align: left;"><strong>Ver un video</strong><small style="color: #777; display:block;">Recupera 1 vida gratis</small></div>
                    <i class="fas fa-video" style="color: var(--secondary); font-size: 1.5rem;"></i>
                </div>
                <div class="life-option" id="buy-option" onclick="SoundEngine.click(); buyLives()">
                    <div style="text-align: left;"><strong>Rellenar Vidas</strong><small style="color: #777; display:block;">Costo: 250 monedas</small></div>
                    <div style="font-weight: bold; color: var(--gold);">250 <i class="fas fa-coins"></i></div>
                </div>
                <div class="life-option premium" id="premium-card" onclick="SoundEngine.click(); toggleCodePanel()"></div>
                <div id="code-panel" class="code-input-container">
                    <p style="font-size: 0.85rem; color: #555; margin-bottom: 10px;">
                        Env√≠a tu ID a soporte para adquirir tu c√≥digo.<br>
                        <strong>Tu ID:</strong> <span id="user-id-display" style="background:#eee; padding:2px 5px; border-radius:4px; font-weight:bold;">Cargando...</span>
                    </p>
                    <button class="btn-full btn-whatsapp" style="padding: 10px; margin-bottom: 15px; font-size: 1rem;" onclick="SoundEngine.click(); contactSupport()">
                        <i class="fab fa-whatsapp"></i> Contactar Soporte
                    </button>
                    <input type="text" id="activation-code" class="code-input" placeholder="INGRESA TU C√ìDIGO">
                    <button class="btn-full btn-action" onclick="SoundEngine.click(); redeemCode()">ACTIVAR</button>
                </div>
            </div>
            <div id="premium-manage" style="display: none; text-align: left; background: #f9f9f9; padding: 15px; border-radius: 15px; margin-bottom: 10px;">
                <h3 style="color: var(--pro); margin-bottom: 5px;">üëë Eres Miembro PRO</h3>
                <p style="font-size: 0.9rem; color: #555; margin-bottom: 10px;">Disfrutas de vidas ilimitadas (La energ√≠a es limitada para todos).</p>
                <div style="font-size: 0.8rem; color: #777; margin-bottom: 15px;">
                    <strong>Vence el:</strong> <span id="expiry-date-display">...</span><br>
                    <strong>Estado:</strong> <span id="sub-status-display" style="color: var(--primary);">Activo</span>
                </div>
                <button id="cancel-btn" class="btn-full btn-danger" onclick="SoundEngine.click(); cancelSubscription()">Cancelar Suscripci√≥n</button>
            </div>
            <button class="btn-full btn-close" onclick="SoundEngine.click(); closeLifeModal()">Cerrar</button>
        </div>
    </div>
    
    <div id="referral-modal" class="overlay modal-center" onclick="closeReferralModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <i class="fas fa-users" style="font-size: 3.5rem; color: var(--secondary); margin-bottom: 10px;"></i>
            <h2 style="margin-bottom: 5px;">Invita y Gana</h2>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">
                Comparte tu ID con amigos.<br>
                <strong style="color:var(--primary)">T√∫ ganas 200 <i class="fas fa-coins"></i></strong> - <strong style="color:var(--gold)">Ellos ganan 100 <i class="fas fa-coins"></i></strong>
            </p>
            
            <div class="ref-box" onclick="SoundEngine.click(); copyRefId()">
                <small style="color:var(--secondary); font-weight:bold;">TU ID PARA COMPARTIR</small>
                <div id="my-ref-id" class="ref-code-display">...</div>
                <small style="color:#999"><i class="fas fa-copy"></i> Toca para copiar</small>
            </div>

            <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                <p style="font-size:0.9rem; font-weight:bold; margin-bottom:10px;">¬øTienes un c√≥digo de amigo?</p>
                <input type="text" id="friend-id-input" class="code-input" placeholder="INGRESA ID DE AMIGO" style="margin-bottom:10px;">
                <button class="btn-full btn-action" onclick="SoundEngine.click(); submitReferralCode()">CANJEAR RECOMPENSA</button>
            </div>
            
            <button class="btn-full" style="background: #eee; color: #555; margin-top:10px;" onclick="SoundEngine.click(); closeReferralModal()">Cerrar</button>
        </div>
    </div>

    <div id="custom-alert" class="overlay" onclick="closeCustomAlert()">
        <div class="alert-box" onclick="event.stopPropagation()">
            <i id="alert-icon" class="alert-icon"></i>
            <h3 id="alert-title" style="margin-bottom: 10px;"></h3>
            <p id="alert-message" style="color: #555; margin-bottom: 20px;"></p>
            <button class="btn-full btn-action" onclick="SoundEngine.click(); closeCustomAlert()">Aceptar</button>
        </div>
    </div>

    <div id="custom-confirm" class="overlay">
        <div class="alert-box" onclick="event.stopPropagation()">
            <i class="fas fa-question-circle alert-icon" style="color:var(--secondary)"></i>
            <h3 id="confirm-title" style="margin-bottom: 10px;"></h3>
            <p id="confirm-message" style="color: #555; margin-bottom: 20px;"></p>
            <div style="display:flex; gap:10px;">
                <button class="btn-full" style="background:#eee; color:#555; margin-top:0;" onclick="SoundEngine.click(); closeCustomConfirm()">Cancelar</button>
                <button class="btn-full btn-action" style="margin-top:0;" id="btn-confirm-action">Confirmar</button>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="SoundEngine.click(); navTo('home-screen', this)">
            <i class="fas fa-home"></i> Inicio
        </div>
        <div class="nav-item" onclick="SoundEngine.click(); navTo('store-screen', this); loadStore();">
            <i class="fas fa-shopping-bag"></i> Canjear
        </div>
    </nav>

    <script>
        /* --- 0. SOUND ENGINE (Sintetizador Web Audio API) --- */
        const SoundEngine = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            playTone: function(freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            click: function() { this.playTone(800, 'sine', 0.05, 0.05); },
            move: function() { 
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(40, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.1);
            },
            capture: function() { 
                if (!this.ctx) this.init();
                this.playTone(200, 'square', 0.1, 0.2); 
                setTimeout(()=> this.playTone(100, 'sawtooth', 0.15, 0.2), 50);
            },
            win: function() {
                if (!this.ctx) this.init();
                let now = this.ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'triangle', 0.3, 0.2), i * 150);
                });
                this.startAmbient();
            },
            lose: function() {
                if (!this.ctx) this.init();
                [440, 415, 392, 349].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'sawtooth', 0.4, 0.2), i * 300);
                });
                this.startAmbient();
            },
            draw: function() {
                if (!this.ctx) this.init();
                [440, 440].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'sine', 0.3, 0.2), i * 200);
                });
                this.startAmbient();
            },
            // Zumbido grave para tiempo agotado (Sawtooth baja frecuencia)
            timeout: function() {
                if (!this.ctx) this.init();
                [150, 100, 80].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'sawtooth', 0.4, 0.3), i * 200);
                });
                this.startAmbient();
            },
            ambientOsc: null,
            startAmbient: function() {
                if(this.ambientOsc) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(220, this.ctx.currentTime); // A3
                gain.gain.setValueAtTime(0.02, this.ctx.currentTime);
                
                const lfo = this.ctx.createOscillator();
                lfo.frequency.value = 0.2; 
                const lfoGain = this.ctx.createGain();
                lfoGain.gain.value = 50; 
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                lfo.start();

                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                this.ambientOsc = {osc, lfo, gain};
            },
            stopAmbient: function() {
                if(this.ambientOsc) {
                    this.ambientOsc.osc.stop();
                    this.ambientOsc.lfo.stop();
                    this.ambientOsc.gain.disconnect();
                    this.ambientOsc = null;
                }
            }
        };

        /* --- 1. FIREBASE INIT --- */
        /* --- 1. FIREBASE INIT --- */
        const firebaseConfig = {
          apiKey: "AIzaSyBTrrF7jiaXfrWmDsFz667X2GiT_wU-Gto",
          authDomain: "checkwin-f87e1.firebaseapp.com",
          databaseURL: "https://checkwin-f87e1-default-rtdb.firebaseio.com",
          projectId: "checkwin-f87e1",
          storageBucket: "checkwin-f87e1.firebasestorage.app",
          messagingSenderId: "99608352111",
          appId: "1:99608352111:web:0e9ad4b2130b44c903449a",
          measurementId: "G-7F67F42098"
        };
        
        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // Si ya existe, usa la instancia actual
        }

        const auth = firebase.auth();
        const db = firebase.database();
        let userId = null;
        let userShortId = null;

        // Iniciar sesi√≥n an√≥nima (Esto funcionar√° porque ya lo activaste en la consola)
        auth.signInAnonymously().catch((error) => {
            console.error("Error Auth:", error);
            customAlert("Error de Conexi√≥n", "No se pudo conectar con el servidor.");
        });

        auth.onAuthStateChanged((user) => { 
            if (user) { 
                userId = user.uid; 
                // Creamos un ID corto para referidos (primeros 8 caracteres)
                userShortId = userId.substring(0, 8).toUpperCase();
                
                // Actualizamos la interfaz con el ID
                const idDisplay = document.getElementById('user-id-display');
                const headerRef = document.getElementById('header-ref-id');
                const myRef = document.getElementById('my-ref-id');

                if(idDisplay) idDisplay.innerText = userShortId; 
                if(headerRef) headerRef.innerText = userShortId;
                if(myRef) myRef.innerText = userShortId;

                // Iniciamos la escucha de datos
                initFirebaseData(); 
            } 
        });

        /* --- 2. GESTI√ìN DE ESTADO (OBJETO MAESTRO) --- */
        const GameConfig = {
            MAX_LIVES: 5,
            REFILL_TIME_MS: 30 * 60 * 1000,
            MAX_ENERGY: 50,
            GAME_ENERGY_COST: 10,
            SURRENDER_ENERGY_PENALTY: 15,
            WIN_ENERGY_REWARD: 3,
            ENERGY_REFILL_MS: 2 * 60 * 1000,
            REFILL_COST: 250
        };

        const UserState = {
            coins: 0,
            lives: 5,
            elo: 1200,
            energy: 50,
            lastLifeLossTime: 0,
            lastEnergyRefillTime: 0,
            isPremium: false,
            premiumExpiry: 0,
            autoRenew: false,
            hasBeenReferred: false
        };

        let subConfig = { title: "Vidas Ilimitadas", price: "$10/mes", priceSub: "", badge: "", color: "#9b59b6", showGift: false, giftTitle: "Oferta", giftMsg: "Info" };
        let activeProvider = 'claro'; 
        let activeCategory = 'recommended'; 

        /* --- PRODUCTOS --- */
        const CLARO_PRODUCTS = [
            { name: 'Todo Incluido 16GB', desc: '30 d√≠as', realPrice: 115, gameCost: 34500, category: 'todo_incluido' },
            { name: 'Todo Incluido 9GB', desc: '15 d√≠as', realPrice: 60, gameCost: 18000, category: 'todo_incluido' },
            { name: 'Todo Incluido 7GB', desc: '7 d√≠as', realPrice: 35, gameCost: 10500, category: 'todo_incluido', recommended: true }, 
            { name: 'Todo Incluido 3.5GB', desc: '3 d√≠as', realPrice: 20, gameCost: 6000, category: 'todo_incluido' },
            { name: 'Todo Incluido 2.5GB', desc: '2 d√≠as', realPrice: 15, gameCost: 4500, category: 'todo_incluido' },
            { name: 'Todo Incluido 1.5GB', desc: '1 d√≠a', realPrice: 12, gameCost: 3600, category: 'todo_incluido' },
            { name: 'Internet 15GB', desc: '30 d√≠as', realPrice: 115, gameCost: 34500, category: 'internet' },
            { name: 'Estudiante 30D', desc: '30 d√≠as', realPrice: 60, gameCost: 18000, category: 'internet' },
            { name: 'Internet 9GB', desc: '15 d√≠as', realPrice: 60, gameCost: 18000, category: 'internet' },
            { name: 'Internet 7GB', desc: '7 d√≠as', realPrice: 35, gameCost: 10500, category: 'internet', recommended: true }, 
            { name: 'Redes Q30 7D', desc: '7 d√≠as', realPrice: 30, gameCost: 9000, category: 'internet' },
            { name: 'Estudiante 7D', desc: '7 d√≠as', realPrice: 25, gameCost: 7500, category: 'internet' },
            { name: 'Internet 4GB (3D)', desc: '3 d√≠as', realPrice: 18, gameCost: 5400, category: 'internet' },
            { name: 'Internet 4GB (1D)', desc: '1 d√≠a', realPrice: 15, gameCost: 4500, category: 'internet' },
            { name: 'Redes Q15 3D', desc: '3 d√≠as', realPrice: 15, gameCost: 4500, category: 'internet' },
            { name: 'Internet 3GB', desc: '2 d√≠as', realPrice: 12, gameCost: 3600, category: 'internet' },
            { name: 'Internet 1.5GB', desc: '1 d√≠a', realPrice: 7, gameCost: 2100, category: 'internet' },
            { name: 'Estudiante 1D', desc: '1 d√≠a', realPrice: 6, gameCost: 1800, category: 'internet' },
            { name: '600 Min Nac/USA + 600 SMS', desc: '15 d√≠as', realPrice: 50, gameCost: 15000, category: 'minutos' },
            { name: '225 Min Nac/USA + 225 SMS', desc: '7 d√≠as', realPrice: 25, gameCost: 7500, category: 'minutos' },
            { name: '180 Min Nac/USA + 180 SMS', desc: '3 d√≠as', realPrice: 15, gameCost: 4500, category: 'minutos' },
            { name: '120 Min Nac/USA + 120 SMS', desc: '2 d√≠as', realPrice: 12, gameCost: 3600, category: 'minutos' },
            { name: '75 Min Nac/USA + 75 SMS', desc: '7 d√≠as', realPrice: 12, gameCost: 3600, category: 'minutos' },
            { name: '50 Min Nac/USA + 50 SMS', desc: '1 d√≠a', realPrice: 7, gameCost: 2100, category: 'minutos' },
            { name: 'Todo Incluido Am√©rica y USA', desc: '30 d√≠as', realPrice: 230, gameCost: 69000, category: 'roaming' },
            { name: '300 MB Resto del Mundo 1', desc: '30 d√≠as', realPrice: 385, gameCost: 115000, category: 'roaming' },
            { name: '50 MB Resto del Mundo 2', desc: '30 d√≠as', realPrice: 2500, gameCost: 750000, category: 'roaming' },
            { name: 'Todo Incluido Europa', desc: '30 d√≠as', realPrice: 310, gameCost: 93000, category: 'roaming' },
            { name: 'Recarga 100', desc: 'Saldo Q100', realPrice: 100, gameCost: 30000, category: 'recarga' },
            { name: 'Recarga 75', desc: 'Saldo Q75', realPrice: 75, gameCost: 22500, category: 'recarga' },
            { name: 'Recarga 50', desc: 'Saldo Q50', realPrice: 50, gameCost: 15000, category: 'recarga' },
            { name: 'Recarga 25', desc: 'Saldo Q25', realPrice: 25, gameCost: 7500, category: 'recarga' },
            { name: 'Recarga 15', desc: 'Saldo Q15', realPrice: 15, gameCost: 4500, category: 'recarga' },
            { name: 'Recarga 10', desc: 'Saldo Q10', realPrice: 10, gameCost: 3000, category: 'recarga', recommended: true }, 
            { name: 'Recarga 5', desc: 'Saldo Q5', realPrice: 5, gameCost: 1500, category: 'recarga' },
        ];

        const TIGO_PRODUCTS = [
            { name: '15 D√≠as 8GB', desc: 'Llamadas a Guate y USA', realPrice: 65, gameCost: 19500, category: 'flex' },
            { name: '30 D√≠as 17GB', desc: 'Llamadas a Guate y USA', realPrice: 125, gameCost: 37500, category: 'flex' },
            { name: '1 D√≠a 800MB', desc: 'Llamadas ILIMITADAS Guate + 30 min Guate/USA', realPrice: 12, gameCost: 3600, category: 'todo_incluido' },
            { name: '2 D√≠as 1.8GB', desc: 'Llamadas ILIMITADAS Guate + minutos Guate/USA', realPrice: 15, gameCost: 4500, category: 'todo_incluido' },
            { name: '3 D√≠as 2.5GB', desc: 'Llamadas Ilimitadas Tigo + 50 min Guate/USA', realPrice: 20, gameCost: 6000, category: 'todo_incluido' },
            { name: '7 D√≠as 5GB', desc: 'Llamadas Ilimitadas Tigo + 100 min Guate/USA', realPrice: 35, gameCost: 10500, category: 'todo_incluido', recommended: true }, 
            { name: '15 D√≠as 7GB', desc: 'Llamadas Ilimitadas Tigo + 200 min Guate/USA', realPrice: 60, gameCost: 18000, category: 'todo_incluido' },
            { name: '30 D√≠as 14GB', desc: 'Llamadas Ilimitadas Tigo + 400 min Guate/USA', realPrice: 115, gameCost: 34500, category: 'todo_incluido' },
            { name: '30 D√≠as 17GB', desc: 'Llamadas Ilimitadas Tigo + 400 min Guate/USA', realPrice: 150, gameCost: 45000, category: 'todo_incluido' },
            { name: 'Comparte Internet 30 D√≠as', desc: '8GB', realPrice: 75, gameCost: 22500, category: 'compartir' },
            { name: '1 D√≠a 800MB', desc: 'Solo Internet', realPrice: 7, gameCost: 2100, category: 'internet' },
            { name: '2 D√≠as 1.6GB', desc: 'Solo Internet', realPrice: 12, gameCost: 3600, category: 'internet' },
            { name: '1 D√≠a 3GB', desc: 'Solo Internet', realPrice: 15, gameCost: 4500, category: 'internet' },
            { name: '3 D√≠as 2.5GB', desc: 'Solo Internet', realPrice: 18, gameCost: 5400, category: 'internet' },
            { name: '50 mins + 50 sms', desc: 'USA y Guate', realPrice: 7, gameCost: 2100, category: 'minutos' },
            { name: '120 mins + 120 sms', desc: 'USA y Guate', realPrice: 12, gameCost: 3600, category: 'minutos' },
            { name: '75 mins + 75 sms', desc: 'USA y Guate', realPrice: 12, gameCost: 3600, category: 'minutos' },
            { name: '500 mins + 500 sms', desc: 'USA y Guate', realPrice: 35, gameCost: 10500, category: 'minutos' },
            { name: '1000 mins + 1200 sms', desc: 'USA y Guate', realPrice: 115, gameCost: 34500, category: 'minutos' },
            { name: 'America sin Caribe 7D', desc: '1.8GB', realPrice: 60, gameCost: 18000, category: 'roaming' },
            { name: 'America sin Caribe 15D', desc: '4GB', realPrice: 110, gameCost: 33000, category: 'roaming' },
            { name: 'America sin Caribe 30D', desc: '6GB + 50mins', realPrice: 150, gameCost: 45000, category: 'roaming' },
            { name: 'Mundial 15 D√≠as', desc: '2GB', realPrice: 199, gameCost: 59700, category: 'roaming' },
            { name: 'Mundial 30 D√≠as', desc: '4GB + 50mins', realPrice: 299, gameCost: 89700, category: 'roaming' },
            { name: 'Recarga Q5', desc: 'Saldo Tigo', realPrice: 5, gameCost: 1500, category: 'recarga' },
            { name: 'Recarga Q10', desc: 'Saldo Tigo', realPrice: 10, gameCost: 3000, category: 'recarga', recommended: true }, 
            { name: 'Recarga Q25', desc: 'Saldo Tigo', realPrice: 25, gameCost: 7500, category: 'recarga' },
            { name: 'Recarga Q50', desc: 'Saldo Tigo', realPrice: 50, gameCost: 15000, category: 'recarga' },
            { name: 'Recarga Q100', desc: 'Saldo Tigo', realPrice: 100, gameCost: 30000, category: 'recarga' },
            { name: 'Recarga Q150', desc: 'Saldo Tigo', realPrice: 150, gameCost: 45000, category: 'recarga' },
            { name: 'Recarga Q200', desc: 'Saldo Tigo', realPrice: 200, gameCost: 60000, category: 'recarga' },
            { name: 'Recarga Q300', desc: 'Saldo Tigo', realPrice: 300, gameCost: 90000, category: 'recarga' },
        ];

        /* --- 3. SYNC FIREBASE --- */
        setInterval(checkRegeneration, 1000); 

        function initFirebaseData() {
            const userRef = db.ref('users/' + userId);
            
            db.ref('requests').orderByChild('userId').equalTo(userId).on('value', (snapshot) => {
                let hasPending = false;
                let completedReqId = null; 

                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const val = child.val();
                        if (val.status === 'pending') hasPending = true;
                        if (val.status === 'completed') completedReqId = child.key;
                    });
                }
                
                const badge = document.getElementById('pending-badge');
                
                if (completedReqId) {
                    badge.style.display = 'flex';
                    badge.innerHTML = '<i class="fas fa-check"></i>';
                    badge.classList.add('success-glow');
                    badge.onclick = () => {
                        customAlert(
                            "¬°Recarga Exitosa!", 
                            "Gracias por confiar en nosotros. Tu paquete ha sido acreditado correctamente.\n¬°A jugar con todo!", 
                            "success",
                            function() {
                                db.ref('requests/' + completedReqId).update({ status: 'archived' });
                            }
                        );
                    };
                    
                } else if (hasPending) {
                    badge.style.display = 'flex';
                    badge.innerHTML = '<i class="fas fa-clock fa-spin"></i>';
                    badge.classList.remove('success-glow'); 
                    badge.onclick = () => customAlert('En Proceso', 'Tu recarga se est√° procesando. Por favor espera un momento.');
                    
                } else {
                    badge.style.display = 'none';
                    badge.classList.remove('success-glow');
                }
            });

            db.ref('config/subscription').on('value', (snapshot) => {
                if(snapshot.exists()) { subConfig = snapshot.val(); renderUI(); }
            });
            
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.banned === true) {
                        document.body.innerHTML = `
                            <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:#000; color:red; text-align:center; padding:20px;">
                                <i class="fas fa-ban" style="font-size:5rem; margin-bottom:20px;"></i>
                                <h1>CUENTA SUSPENDIDA</h1>
                                <p>Tu cuenta ha sido desactivada por violar los t√©rminos de servicio.</p>
                            </div>`;
                        return;
                    }
                    
                    UserState.coins = data.coins || 0;
                    UserState.lives = (data.lives !== undefined) ? data.lives : 5;
                    UserState.elo = (data.elo !== undefined) ? data.elo : 1200;
                    UserState.lastLifeLossTime = data.lastLifeLossTime || 0;
                    UserState.energy = (data.energy !== undefined) ? data.energy : 50;
                    UserState.lastEnergyRefillTime = data.lastEnergyRefillTime || 0;

                    UserState.hasBeenReferred = data.referredBy ? true : false;
                    const inputField = document.getElementById('friend-id-input');
                    const redeemBtn = document.querySelector('#referral-modal .btn-action');
                    if(UserState.hasBeenReferred && inputField && redeemBtn) {
                        inputField.value = "YA CANJEASTE";
                        inputField.disabled = true;
                        redeemBtn.disabled = true;
                        redeemBtn.innerText = "C√ìDIGO YA USADO";
                        redeemBtn.style.background = "#ccc";
                        redeemBtn.style.boxShadow = "none";
                    }

                    if (data.pendingReferralReward === true) {
                        customAlert("¬°Felicidades!", "¬°Un amigo us√≥ tu c√≥digo!\nHas ganado +200 Monedas.", "success");
                        setTimeout(() => closeCustomAlert(), 4000);
                        db.ref('users/' + userId).update({ pendingReferralReward: null });
                    }

                    UserState.premiumExpiry = data.premiumExpiry || 0;
                    UserState.autoRenew = data.autoRenew || false; 
                    
                    if (Date.now() < UserState.premiumExpiry) {
                        UserState.isPremium = true; 
                    } else { 
                        UserState.isPremium = false; 
                        UserState.autoRenew = false; 
                    }
                    
                    renderUI();
                } else { saveToFirebase(); renderUI(); }
            });
        }

        function saveToFirebase() {
            if (!userId) return;
            db.ref('users/' + userId).update({ 
                coins: UserState.coins, 
                lives: UserState.lives, 
                elo: UserState.elo,
                lastLifeLossTime: UserState.lastLifeLossTime,
                energy: UserState.energy,
                lastEnergyRefillTime: UserState.lastEnergyRefillTime,
                premiumExpiry: UserState.premiumExpiry, 
                autoRenew: UserState.autoRenew 
            });
        }

        /* --- 4. UI RENDERIZADO --- */
        let proInterval = null; 

        function updateProAnimation(isPremium) {
            const badge = document.querySelector('.hearts');
            const icon = document.getElementById('life-icon');
            const text = document.getElementById('lives-count');

            if (!isPremium) {
                clearInterval(proInterval);
                proInterval = null;
                badge.classList.remove('pro-active');
                icon.className = 'fas fa-heart';
                text.innerText = UserState.lives;
                return;
            }

            if (!proInterval) {
                badge.classList.remove('pro-active');
                icon.className = 'fas fa-heart';
                text.innerText = "‚àû";

                let showPro = true;
                proInterval = setInterval(() => {
                    if (showPro) {
                        badge.classList.add('pro-active');
                        icon.className = 'fas fa-crown';
                        text.innerText = "PRO";
                    } else {
                        badge.classList.remove('pro-active');
                        icon.className = 'fas fa-heart';
                        text.innerText = "‚àû";
                    }
                    showPro = !showPro;
                }, 3000); 
            }
        }

        function renderUI() {
            const coinsEl = document.getElementById('coins-count');
            const eloEl = document.getElementById('elo-count');
            const energyEl = document.getElementById('energy-count');
            const lifeTimerEl = document.getElementById('life-timer');
            const energyTimerEl = document.getElementById('energy-timer');

            coinsEl.innerText = UserState.coins;
            eloEl.innerText = UserState.elo;
            energyEl.innerText = UserState.energy;

            updateProAnimation(UserState.isPremium);

            if (!UserState.isPremium) {
                document.getElementById('lives-count').innerText = UserState.lives;
            }

            const cardEl = document.getElementById('premium-card');
            cardEl.style.borderColor = subConfig.color;
            cardEl.style.background = `linear-gradient(to right, ${subConfig.color}22, white)`;
            
            let priceHtml = '';
            if (subConfig.priceSub && subConfig.priceSub.trim() !== "") {
                priceHtml = `
                    <div style="line-height:1.2;">
                        <span style="text-decoration: line-through; color: #999; font-size: 0.8rem;">${subConfig.price}</span>
                        <br>
                        <span style="color: #e74c3c; font-weight:800; font-size: 1.1rem; text-shadow: 0px 0px 1px rgba(0,0,0,0.1);">${subConfig.priceSub}</span>
                    </div>
                `;
            } else {
                priceHtml = `<small style="color: #777; display:block;">${subConfig.price}</small>`;
            }

            let htmlContent = `
                <div style="text-align: left;">
                    <strong style="color: ${subConfig.color}; font-size: 1rem;">${subConfig.title}</strong>
                    ${priceHtml}
                </div>
                <i class="fas fa-crown" style="color: ${subConfig.color}; font-size: 1.5rem;"></i>
            `;
            if(subConfig.badge && subConfig.badge.trim() !== "") htmlContent += `<div class="offer-badge">${subConfig.badge}</div>`;
            if(subConfig.showGift) htmlContent += `<div class="gift-icon" onclick="event.stopPropagation(); showGiftAlert()"><i class="fas fa-gift"></i></div>`;
            
            cardEl.innerHTML = htmlContent;

            if (UserState.isPremium) {
                lifeTimerEl.innerText = "";
                if(UserState.energy < GameConfig.MAX_ENERGY) { } else { energyTimerEl.innerText = ""; }
                
                document.getElementById('modal-icon').className = "fas fa-crown"; 
                document.getElementById('modal-icon').style.color = subConfig.color;
                document.getElementById('normal-options').style.display = 'none'; 
                document.getElementById('premium-manage').style.display = 'block'; 
                
                const dateObj = new Date(UserState.premiumExpiry);
                document.getElementById('expiry-date-display').innerText = dateObj.toLocaleDateString();
                const statusTxt = document.getElementById('sub-status-display');
                const cancelBtn = document.getElementById('cancel-btn');

                if (UserState.autoRenew) { statusTxt.innerText = "Activo"; statusTxt.style.color = "var(--primary)"; cancelBtn.style.display = "block"; } 
                else { statusTxt.innerText = "Cancelado (Vence pronto)"; statusTxt.style.color = "var(--danger)"; cancelBtn.style.display = "none"; }
            } else {
                document.getElementById('modal-icon').className = "fas fa-heart-crack"; 
                document.getElementById('modal-icon').style.color = "var(--danger)";
                document.getElementById('normal-options').style.display = 'block'; 
                document.getElementById('premium-manage').style.display = 'none';
            }
            
            if (document.getElementById('life-modal').style.display === 'flex') updateLifeShopButtons();
            if (document.getElementById('store-screen').classList.contains('active')) loadStore(); 
        }

        /* --- 5. MOTOR DE AJEDREZ (STOCKFISH 10) --- */
        var board = null;
        var game = new Chess();
        var setup = { diff: 'easy', color: 'white', time: 10 };
        var playerColor = 'w';
        var timerInterval = null;
        var whiteTime = 0, blackTime = 0;
        var gameActive = false;
        var selectedSquare = null;
        
        var moveHistory = [];
        var reviewIndex = 0;
        var isPlayingReview = false;
        var reviewInterval = null;

        var premoves = [];

        // Stockfish Worker (Carga en Blob para un solo archivo)
        const stockfishScript = "importScripts('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js');";
        const workerBlob = new Blob([stockfishScript], { type: 'application/javascript' });
        const stockfish = new Worker(URL.createObjectURL(workerBlob));

        stockfish.postMessage('uci');

        stockfish.onmessage = function(event) {
            const line = event.data;
            if (line && line.startsWith('bestmove')) {
                const match = line.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbn])?/);
                if (match) {
                    const from = match[1];
                    const to = match[2];
                    const promotion = match[3];

                    // --- C√ÅLCULO DEL "FACTOR HUMANO" (DELAY) ---
                    let delay = 0;
                    
                    // Tiempo restante de la IA
                    const aiTimeLeft = (playerColor === 'w' ? blackTime : whiteTime);

                    // Si le queda poco tiempo (< 20 seg), mueve R√ÅPIDO (p√°nico)
                    if (aiTimeLeft < 20) {
                        delay = 100; // 0.1 segundos (Casi instant√°neo)
                    } 
                    // Si es una partida Blitz (1 minuto)
                    else if (setup.time === 1) {
                        delay = Math.floor(Math.random() * 1000) + 500; // Entre 0.5 y 1.5 seg
                    } 
                    // Si es partida Normal (5, 10, 30 min)
                    else {
                        delay = Math.floor(Math.random() * 2000) + 1000; // Entre 1 y 3 seg
                    }

                    // Ejecutar el movimiento despu√©s del "pensamiento simulado"
                    setTimeout(() => {
                        // Verificar que el juego siga activo antes de mover
                        if (!gameActive) return;

                        const move = game.move({ from: from, to: to, promotion: promotion || 'q' });
                        board.position(game.fen());
                        
                        if (move && move.captured) SoundEngine.capture();
                        else SoundEngine.move(); 

                        checkWinCondition();
                        updateGameStatus();

                        // Manejo de Premoves (Tus movimientos adelantados)
                        if (premoves.length > 0 && gameActive) {
                            // Peque√±a pausa para que se vea tu premove
                            setTimeout(() => {
                                const nextPremove = premoves.shift(); 
                                const pm = game.move({ from: nextPremove.from, to: nextPremove.to, promotion: 'q' });
                                if (pm !== null) {
                                    board.position(game.fen());
                                    if (pm.captured) SoundEngine.capture();
                                    else SoundEngine.move(); 
                                    removeHighlights(); 
                                    renderPremoves(); 
                                    updateGameStatus(); 
                                    checkWinCondition();
                                    if (!checkWinCondition()) triggerAI();
                                } else {
                                    premoves = []; 
                                    removeHighlights(); 
                                    renderPremoves();
                                    customAlert("Premove Cancelado", "El movimiento ya no es v√°lido.", "error");
                                }
                            }, 200);
                        }
                    }, delay);
                }
            }
        };


        function triggerAI() {
            // Cambiar indicador visual
            document.getElementById('player-dot').classList.remove('active'); 
            document.getElementById('ai-dot').classList.add('active'); 
            document.getElementById('game-status-text').innerText = "IA Pensando..."; 
            
            stockfish.postMessage('position fen ' + game.fen());

            const wTimeMs = whiteTime * 1000;
            const bTimeMs = blackTime * 1000;
            const myTimeRemaining = (playerColor === 'w' ? blackTime : whiteTime);

            // Si le queda muy poco tiempo, forzar c√°lculo r√°pido
            if (myTimeRemaining < 10) {
                stockfish.postMessage('go movetime 100');
                return;
            }

            if (setup.diff === 'easy') {
                // F√°cil: Piensa muy poco (el delay visual lo hace ver humano)
                stockfish.postMessage('setoption name Skill Level value 5');
                stockfish.postMessage('go depth 2'); 
            } else if (setup.diff === 'med') {
                // Medio: Nivel decente
                stockfish.postMessage('setoption name Skill Level value 10');
                stockfish.postMessage('go depth 10');
            } else {
                // Pro: Usa el tiempo real para calcular fuerte
                stockfish.postMessage('setoption name Skill Level value 20');
                stockfish.postMessage('setoption name Contempt value 20'); 
                
                // En partidas largas, deja que piense m√°s
                let searchTime = (setup.time === 1) ? 500 : 2000; 
                stockfish.postMessage(`go movetime ${searchTime}`);
            }
        }


        /* --- FUNCIONES DE JUEGO --- */
        
        function openSetupModal() { 
            if(!UserState.isPremium && UserState.lives<=0) { openLifeShop(); return; }
            if(UserState.energy < GameConfig.GAME_ENERGY_COST) { 
                customAlert("Sin Energ√≠a", `Necesitas ${GameConfig.GAME_ENERGY_COST} de energ√≠a para jugar.`, "error");
                return;
            }
            document.getElementById('setup-modal').style.display = 'flex'; 
        }

        function closeSetupModal() { document.getElementById('setup-modal').style.display = 'none'; }
        
        function selectOpt(type, val) {
            setup[type] = val;
            document.querySelectorAll(`[id^='opt-${type}-']`).forEach(el => el.classList.remove('selected'));
            document.getElementById(`opt-${type}-${val}`).classList.add('selected');
        }

        function launchGame() {
            if (UserState.energy >= GameConfig.GAME_ENERGY_COST) {
                if (UserState.energy === GameConfig.MAX_ENERGY) UserState.lastEnergyRefillTime = Date.now();
                UserState.energy -= GameConfig.GAME_ENERGY_COST;
                saveToFirebase();
            } else {
                customAlert("Error", "No tienes energ√≠a suficiente.", "error");
                return;
            }

            document.getElementById('btn-game-stats').classList.add('disabled');
            document.getElementById('surrender-btn').style.display = 'block';
            document.getElementById('review-panel').style.display = 'none';
            
            const statusText = document.getElementById('game-status-text');
            statusText.style.display = 'block';
            statusText.innerText = "Esperando...";

            stopReviewPlay();
            
            closeSetupModal();
            navTo('game-screen');
            document.getElementById('ai-level-txt').innerText = setup.diff === 'easy' ? 'F√°cil' : (setup.diff === 'med' ? 'Medio' : 'Pro');
            
            if(setup.color === 'white') playerColor = 'w'; 
            else if(setup.color === 'black') playerColor = 'b'; 
            else playerColor = Math.random() < 0.5 ? 'w' : 'b'; 
            
            whiteTime = setup.time * 60; 
            blackTime = setup.time * 60;
            
            game.reset(); 
            gameActive = true;
            selectedSquare = null;
            premoves = []; 
            
            if(board) board.destroy();
            
            board = Chessboard('myBoard', { 
                draggable: false,  
                position: 'start', 
                orientation: playerColor === 'w' ? 'white' : 'black',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' 
            });

            $('#myBoard').off('click').on('click', '.square-55d63', handleBoardClick);

            stockfish.postMessage('ucinewgame');

            startTimer(); updateGameStatus();
            
            if(playerColor === 'b') {
                setTimeout(triggerAI, 500); 
            }
        }
        
        function handleBoardClick() {
            if(!gameActive) return;
            
            var square = $(this).attr('data-square');
            var piece = game.get(square);

            if (game.turn() !== playerColor) {
                if (selectedSquare) {
                    if (premoves.length < 5) {
                        premoves.push({ from: selectedSquare, to: square });
                        renderPremoves(); 
                    }
                    selectedSquare = null;
                    removeHighlights();
                } else {
                    if (piece && piece.color === playerColor) {
                        selectedSquare = square;
                        highlightSquare(square); 
                    }
                }
                return;
            }

            if (selectedSquare === null) {
                if (piece && piece.color === playerColor) { selectedSquare = square; highlightSquare(square); }
                return;
            }
            
            var move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
            if (move !== null) {
                board.position(game.fen()); 
                
                if (move.captured) SoundEngine.capture();
                else SoundEngine.move(); 

                removeHighlights(); selectedSquare = null;
                updateGameStatus(); 
                if(!checkWinCondition()) {
                     triggerAI();
                }
            } else {
                if (piece && piece.color === playerColor) { removeHighlights(); selectedSquare = square; highlightSquare(square); } 
                else { removeHighlights(); selectedSquare = null; }
            }
        }

        function highlightSquare(sq) { $('.square-55d63').removeClass('highlight-square'); $('.square-' + sq).addClass('highlight-square'); }
        function removeHighlights() { $('.square-55d63').removeClass('highlight-square'); }
        
        function renderPremoves() {
            $('.square-55d63').removeClass('premove-square');
            premoves.forEach(pm => {
                $('.square-' + pm.from).addClass('premove-square');
                $('.square-' + pm.to).addClass('premove-square');
            });
        }

                function startTimer() {
            clearInterval(timerInterval); 
            updateTimerUI();
            
            timerInterval = setInterval(() => {
                if(!gameActive) { clearInterval(timerInterval); return; }
                
                // Si es turno de las BLANCAS
                if(game.turn() === 'w') { 
                    whiteTime--; 
                    if(whiteTime <= 0) {
                        // Se acab√≥ el tiempo blanco. 
                        // Si yo soy blanco -> PERD√ç. Si yo soy negro -> GAN√â.
                        if (playerColor === 'w') endGame('lose_time');
                        else endGame('win_time');
                    }
                } 
                // Si es turno de las NEGRAS
                else { 
                    blackTime--; 
                    if(blackTime <= 0) { 
                        // Se acab√≥ el tiempo negro.
                        // Si yo soy negro -> PERD√ç. Si yo soy blanco -> GAN√â.
                        if (playerColor === 'b') endGame('lose_time');
                        else endGame('win_time');
                    }
                }
                updateTimerUI();
            }, 1000);
        }

        function updateTimerUI() {
            const fmt = (t) => { let m = Math.floor(t / 60); let s = t % 60; return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`; };
            let pTimeStr = playerColor === 'w' ? fmt(whiteTime) : fmt(blackTime);
            let aiTimeStr = playerColor === 'w' ? fmt(blackTime) : fmt(whiteTime);
            document.getElementById('player-timer').innerText = pTimeStr; document.getElementById('ai-timer').innerText = aiTimeStr;
            document.getElementById('player-timer').classList.toggle('active', game.turn() === playerColor);
            document.getElementById('ai-timer').classList.toggle('active', game.turn() !== playerColor);
            document.getElementById('player-dot').className = `turn-dot ${game.turn() === playerColor ? 'active' : ''}`;
            document.getElementById('ai-dot').className = `turn-dot ${game.turn() !== playerColor ? 'active' : ''}`;
        }

        function calculateEloChange(currentElo, result, difficulty) {
            let aiRating = 1600; 
            if (difficulty === 'med') aiRating = 2100;
            if (difficulty === 'hard') aiRating = 3000;

            const K = 32;

            let actualScore = (result === 'win' || result === 'win_time') ? 1 : ((result === 'draw') ? 0.5 : 0);
            let expectedScore = 1 / (1 + Math.pow(10, (aiRating - currentElo) / 400));
            let change = Math.round(K * (actualScore - expectedScore));

            if (actualScore === 1 && change <= 0) change = 1;

            return change;
        }

        function endGame(result) {
            gameActive = false; clearInterval(timerInterval); removeHighlights();
            $('.square-55d63').removeClass('premove-square'); 
            document.getElementById('game-status-text').style.display = 'none';

            let title = "", msg = "", iconClass = "", color = "";
            let coinDiff = 0, lifeDiff = 0, energyDiff = 0, eloDiff = 0;

            eloDiff = calculateEloChange(UserState.elo, result, setup.diff);

            if(result === 'win' || result === 'win_time') {
                SoundEngine.win(); 
                let base = (setup.diff === 'med') ? 20 : (setup.diff === 'hard' ? 40 : 10);
                let mult = (setup.time === 1) ? 2.0 : ((setup.time === 5) ? 1.5 : (setup.time === 30 ? 0.5 : 1.0));
                coinDiff = Math.floor(base * mult);
                energyDiff = GameConfig.WIN_ENERGY_REWARD;
                UserState.energy += energyDiff;
                title = "¬°VICTORIA!"; msg = "Has ganado la partida."; iconClass = "fas fa-trophy"; color = "var(--primary)";
                UserState.coins += coinDiff;
            } else if (result === 'lose_mate') {
                SoundEngine.lose(); 
                lifeDiff = UserState.isPremium ? 0 : -1; coinDiff = -15; if(UserState.coins < 15) coinDiff = -UserState.coins;
                title = "JAQUE MATE"; msg = "La IA te ha derrotado."; iconClass = "fas fa-skull"; color = "var(--danger)";
                UserState.coins += coinDiff;
                if (!UserState.isPremium) { 
                    if (UserState.lives === GameConfig.MAX_LIVES) UserState.lastLifeLossTime = Date.now(); 
                    UserState.lives += lifeDiff; 
                    if(UserState.lives < 0) UserState.lives = 0; 
                }
            } else if (result === 'lose_time') {
                SoundEngine.timeout();
                lifeDiff = UserState.isPremium ? 0 : -2; coinDiff = -30; if(UserState.coins < 30) coinDiff = -UserState.coins;
                title = "TIEMPO AGOTADO"; msg = "Se te acab√≥ el reloj."; iconClass = "fas fa-hourglass-end"; color = "var(--danger)";
                UserState.coins += coinDiff;
                if (!UserState.isPremium) { 
                    if (UserState.lives === GameConfig.MAX_LIVES) UserState.lastLifeLossTime = Date.now(); 
                    UserState.lives += lifeDiff; 
                    if(UserState.lives < 0) UserState.lives = 0; 
                }
            } else if (result === 'surrender') {
                SoundEngine.lose();
                energyDiff = -GameConfig.SURRENDER_ENERGY_PENALTY;
                lifeDiff = UserState.isPremium ? 0 : -3; 
                coinDiff = 0;
                eloDiff = -15; 
                title = "RENDICI√ìN"; msg = "Rendirse tiene penalizaci√≥n."; iconClass = "fas fa-flag"; color = "#777";
                if (!UserState.isPremium) { 
                    if (UserState.lives === GameConfig.MAX_LIVES) UserState.lastLifeLossTime = Date.now(); 
                    UserState.lives += lifeDiff; 
                    if(UserState.lives < 0) UserState.lives = 0; 
                }
                if (UserState.energy === GameConfig.MAX_ENERGY) UserState.lastEnergyRefillTime = Date.now();
                UserState.energy += energyDiff; if(UserState.energy < 0) UserState.energy = 0;
            } else if (result === 'draw') {
                SoundEngine.draw(); 
                title = "TABLAS"; msg = "Empate t√©cnico."; iconClass = "fas fa-handshake"; color = "var(--secondary)";
            }

            UserState.elo += eloDiff;
            if(UserState.elo < 0) UserState.elo = 0;

            saveToFirebase();

            document.getElementById('go-title').innerText = title; document.getElementById('go-title').style.color = color; document.getElementById('go-msg').innerText = msg;
            document.getElementById('go-icon').className = iconClass; document.getElementById('go-icon').style.color = color;
            const cEl = document.getElementById('go-coins'); cEl.innerText = (coinDiff >= 0 ? "+" : "") + coinDiff; cEl.style.color = coinDiff >= 0 ? "var(--primary)" : "var(--danger)";
            const lEl = document.getElementById('go-lives'); lEl.innerText = UserState.isPremium ? "‚àû" : (lifeDiff >= 0 ? "+"+lifeDiff : lifeDiff); lEl.style.color = "var(--danger)";
            
            const eEl = document.getElementById('go-energy'); 
            eEl.innerText = (energyDiff > 0 ? "+" + energyDiff : (energyDiff < 0 ? energyDiff : "-0")); 
            eEl.style.color = energyDiff > 0 ? "var(--primary)" : (energyDiff < 0 ? "var(--danger)" : "#777");

            const eloModalEl = document.getElementById('go-elo');
            eloModalEl.innerText = (eloDiff >= 0 ? "+" : "") + eloDiff;
            eloModalEl.style.color = eloDiff >= 0 ? "var(--primary)" : "var(--danger)";
            
            document.getElementById('surrender-btn').style.display = 'none'; 
            document.getElementById('review-panel').style.display = 'flex'; 
            
            moveHistory = game.history();
            reviewIndex = moveHistory.length;
            renderMoveHistory(); 
            highlightCurrentMove(); 

            document.getElementById('btn-game-stats').classList.remove('disabled'); 
            showGameOverModal();
        }

        /* --- REVIEW SYSTEM --- */
        function renderMoveHistory() {
            const container = document.getElementById('move-history-container');
            container.innerHTML = '';
            moveHistory.forEach((move, index) => {
                if (index % 2 === 0) {
                    const numSpan = document.createElement('span');
                    numSpan.className = 'move-number';
                    numSpan.innerText = `${(index / 2) + 1}.`;
                    container.appendChild(numSpan);
                }
                const moveSpan = document.createElement('span');
                moveSpan.className = 'move-item';
                moveSpan.id = `move-${index + 1}`; 
                moveSpan.innerText = move;
                container.appendChild(moveSpan);
            });
        }

        function highlightCurrentMove() {
            document.querySelectorAll('.move-item').forEach(el => el.classList.remove('active-move'));
            if (reviewIndex > 0) {
                const currentId = `move-${reviewIndex}`;
                const el = document.getElementById(currentId);
                if (el) {
                    el.classList.add('active-move');
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }
        }

        function reviewBack() {
            if (reviewIndex > 0) {
                game.undo(); board.position(game.fen()); reviewIndex--; highlightCurrentMove();
            }
        }
        function reviewForward() {
            if (reviewIndex < moveHistory.length) {
                game.move(moveHistory[reviewIndex]); board.position(game.fen()); reviewIndex++; highlightCurrentMove();
            } else { stopReviewPlay(); }
        }
        function reviewStart() {
            while (reviewIndex > 0) { game.undo(); reviewIndex--; }
            board.position(game.fen()); highlightCurrentMove();
        }
        function reviewEnd() {
            while (reviewIndex < moveHistory.length) { game.move(moveHistory[reviewIndex]); reviewIndex++; }
            board.position(game.fen()); highlightCurrentMove();
        }
        function togglePlay() {
            if (isPlayingReview) { stopReviewPlay(); } 
            else { isPlayingReview = true; document.getElementById('play-icon').className = 'fas fa-pause'; reviewInterval = setInterval(reviewForward, 1000); }
        }
        function stopReviewPlay() {
            isPlayingReview = false;
            if(document.getElementById('play-icon')) document.getElementById('play-icon').className = 'fas fa-play';
            clearInterval(reviewInterval);
        }

        /* --- NAVEGACI√ìN Y UTILIDADES --- */
        function showGameOverModal() { 
            const modal = document.getElementById('game-over-modal');
            const box = modal.querySelector('.modal-box'); // Seleccionamos la cajita blanca
            
            modal.style.display = 'flex'; 
            
            // --- PROTECCI√ìN ANTI-CLIC ACCIDENTAL ---
            // Desactiva los botones por 1.5 segundos para que veas el resultado
            box.style.pointerEvents = 'none'; 
            box.style.opacity = '0.9'; // Un poco transparente para indicar "espera"
            
            setTimeout(() => {
                box.style.pointerEvents = 'auto'; // Reactiva los clics
                box.style.opacity = '1'; 
            }, 1500);
        }

        
        function closeGameOverModal() { 
            SoundEngine.stopAmbient(); 
            document.getElementById('game-over-modal').style.display = 'none'; 
        }

        function rematch() {
            SoundEngine.stopAmbient();
            if(!UserState.isPremium && UserState.lives <= 0) { customAlert("Sin Vidas", "No tienes vidas suficientes.", "error"); return; }
            if(UserState.energy < GameConfig.GAME_ENERGY_COST) { customAlert("Sin Energ√≠a", "Espera a recargar.", "error"); return; }
            document.getElementById('game-over-modal').style.display = 'none';
            launchGame();
        }

        function goToMenu() { 
            SoundEngine.stopAmbient();
            document.getElementById('game-over-modal').style.display = 'none'; navTo('home-screen'); 
        }
        function checkWinCondition() { if (game.in_checkmate()) { if(game.turn() !== playerColor) endGame('win'); else endGame('lose_mate'); return true; } if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) { endGame('draw'); return true; } return false; }
        function updateGameStatus() { let status = ""; if (game.in_check()) status = "¬°JAQUE!"; else status = (game.turn() === playerColor) ? "Tu turno" : "Pensando..."; document.getElementById('game-status-text').innerText = status; updateTimerUI(); }
        
        function quitGame() { 
            if (UserState.energy < GameConfig.SURRENDER_ENERGY_PENALTY) {
                customAlert("¬°Imposible!", `Necesitas ${GameConfig.SURRENDER_ENERGY_PENALTY} energ√≠a para rendirte. ¬°Lucha!`, "error");
                return;
            }
            if (!UserState.isPremium && UserState.lives < 3) {
                customAlert("¬°Imposible!", "Necesitas 3 vidas para rendirte. ¬°Juega hasta el final!", "error");
                return;
            }
            showConfirm("¬øRendirse?", `Costar√°:\n‚ö° -${GameConfig.SURRENDER_ENERGY_PENALTY} Energ√≠a\n‚ù§Ô∏è -3 Vidas`, function() {
                endGame('surrender');
            });
        }

        function navTo(screenId, btn) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            document.getElementById(screenId).classList.add('active'); 
            if(btn) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); btn.classList.add('active'); }
            const nav = document.querySelector('nav');
            if (screenId === 'game-screen') { nav.style.display = 'none'; } else { nav.style.display = 'flex'; }
        }

        function switchProvider(prov, btn) { activeProvider = prov; activeCategory = 'recommended'; document.querySelectorAll('.prov-btn').forEach(b => b.classList.remove('active', 'claro', 'tigo')); btn.classList.add('active'); if(prov === 'claro') btn.classList.add('claro'); if(prov === 'tigo') btn.classList.add('tigo'); loadStore(); }
        
        function switchCategory(cat, btn) { activeCategory = cat; document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadStore(); }
        
        function renderCategories() { 
            const catContainer = document.getElementById('category-switch'); 
            catContainer.innerHTML = ''; 
            
            const recBtn = document.createElement('button');
            recBtn.className = `cat-btn ${activeCategory === 'recommended' ? 'active' : ''}`;
            recBtn.innerHTML = '<i class="fas fa-star" style="color:var(--gold)"></i> Recomendados';
            recBtn.onclick = () => { SoundEngine.click(); switchCategory('recommended', recBtn); }
            catContainer.appendChild(recBtn);

            let categories = [];
            if (activeProvider === 'claro') {
                categories = [
                    {id:'all',name:'Todo'}, 
                    {id:'todo_incluido',name:'Superpack Todo Incluido'},
                    {id:'internet',name:'Superpack Internet'},
                    {id:'minutos',name:'Minutos y SMS'},
                    {id:'roaming',name:'Roaming'},
                    {id:'recarga',name:'Recargas'}
                ];
            } else {
                categories = [
                    {id:'all',name:'Todo'}, 
                    {id:'flex',name:'Tigo Flex'},
                    {id:'todo_incluido',name:'Todo Incluido'},
                    {id:'compartir',name:'Compartir'},
                    {id:'internet',name:'Solo Internet'},
                    {id:'minutos',name:'Solo Minutos'},
                    {id:'roaming',name:'Roaming'},
                    {id:'recarga',name:'Recargas'}
                ];
            }

            categories.forEach(c => { 
                const btn = document.createElement('button'); 
                btn.className = `cat-btn ${activeCategory === c.id ? 'active' : ''}`; 
                btn.innerText = c.name; 
                btn.onclick = () => { SoundEngine.click(); switchCategory(c.id, btn); }
                catContainer.appendChild(btn); 
            }); 
        }
        
/* --- VARIABLES GLOBALES PARA LA TIENDA 3D --- */
let storeIndex = 0;
let storeItemsData = []; // Guardar√° los datos filtrados actuales
let touchStartX = 0;
let touchEndX = 0;

/* --- NUEVA FUNCI√ìN LOAD STORE (COVERFLOW) --- */
/* --- FUNCI√ìN LOAD STORE CON TRANSICI√ìN --- */
function loadStore() {
    const list = document.getElementById('products-list');
    
    // 1. Iniciar el desvanecimiento (fade-out)
    list.classList.add('fade-out');

    // 2. Esperar a que termine la transici√≥n (300ms) antes de cambiar el contenido
    setTimeout(() => {
        renderCategories(); 
        list.innerHTML = ''; 
        
        // Configurar gestos t√°ctiles
        list.removeEventListener('touchstart', handleTouchStart);
        list.removeEventListener('touchend', handleTouchEnd);
        list.addEventListener('touchstart', handleTouchStart, {passive: false});
        list.addEventListener('touchend', handleTouchEnd, {passive: false});

        // Filtrar datos
        const allProducts = activeProvider === 'claro' ? CLARO_PRODUCTS : TIGO_PRODUCTS; 
        
        if (activeCategory === 'recommended') {
            storeItemsData = allProducts.filter(p => p.recommended === true);
        } else if (activeCategory === 'all') {
            storeItemsData = allProducts;
        } else {
            storeItemsData = allProducts.filter(p => p.category === activeCategory);
        }

        if (storeItemsData.length === 0) { 
            list.innerHTML = '<p style="text-align: center; color: #777; margin-top: 30px;">No hay paquetes disponibles.</p>';
            // Importante: remover fade-out para mostrar el mensaje
            list.classList.remove('fade-out');
            return; 
        }

        // Resetear √≠ndice
        storeIndex = Math.floor(storeItemsData.length / 2);
        if(storeIndex < 0) storeIndex = 0;

        // Generar tarjetas
        storeItemsData.forEach((p, index) => {
            const card = document.createElement('div');
            const styleClass = activeProvider === 'claro' ? 'claro-card' : 'tigo-card';
            let icon = "fa-mobile-alt";
            if(p.category.includes('internet')) icon = "fa-wifi";
            if(p.category.includes('recarga')) icon = "fa-wallet";
            if(p.category.includes('roaming')) icon = "fa-globe-americas";
            
            card.className = `coverflow-card ${styleClass}`;
            card.id = `card-${index}`;
            card.onclick = () => {
                if (index !== storeIndex) {
                    storeIndex = index;
                    SoundEngine.move();
                    updateCoverflow();
                }
            };

            card.innerHTML = `
                <div>
                    <div class="cf-header">${p.name}</div>
                    <small style="color:#999; text-transform:uppercase; font-size:0.7rem; letter-spacing:1px;">${activeProvider}</small>
                </div>
                <i class="fas ${icon} cf-icon"></i>
                <div class="cf-desc">${p.desc}</div>
                <div class="cf-price-box">
                    <span class="cf-real-price">Q${p.realPrice}.00</span>
                    <div class="cf-game-price">${p.gameCost} <i class="fas fa-coins" style="font-size:1rem;"></i></div>
                </div>
                <button class="buy-btn" style="width:100%; margin-top:0;" 
                    onclick="event.stopPropagation(); redeem('${p.name}', ${p.gameCost}, ${p.realPrice})" 
                    ${UserState.coins < p.gameCost ? 'disabled' : ''}>
                    CANJEAR
                </button>
            `;
            list.appendChild(card);
        });

        // Agregar indicador
        const hint = document.createElement('div');
        hint.innerHTML = '<i class="fas fa-hand-pointer fa-bounce"></i> Desliza para ver m√°s';
        hint.style.cssText = "position:absolute; bottom:10px; width:100%; text-align:center; color:#aaa; font-size:0.8rem; pointer-events:none;";
        list.appendChild(hint);

        updateCoverflow();

        // 3. Iniciar la aparici√≥n (fade-in)
        list.classList.remove('fade-out');

    }, 300); // Este tiempo debe coincidir con el de tu CSS (0.3s = 300ms)
}


/* --- L√ìGICA DE ACTUALIZACI√ìN VISUAL --- */
function updateCoverflow() {
    storeItemsData.forEach((_, i) => {
        const el = document.getElementById(`card-${i}`);
        if(!el) return;

        // Limpiar clases de estado
        el.classList.remove('cf-center', 'cf-left', 'cf-right', 'cf-left-far', 'cf-right-far');

        const diff = i - storeIndex;

        if (diff === 0) {
            el.classList.add('cf-center'); // Tarjeta central
        } else if (diff === -1) {
            el.classList.add('cf-left'); // Inmediata izquierda
        } else if (diff === 1) {
            el.classList.add('cf-right'); // Inmediata derecha
        } else if (diff < -1) {
            el.classList.add('cf-left-far'); // Lejos izquierda (invisible u opaco)
        } else {
            el.classList.add('cf-right-far'); // Lejos derecha
        }
    });
}

/* --- CONTROL GESTUAL (SWIPE) --- */
function handleTouchStart(e) {
    touchStartX = e.changedTouches[0].screenX;
}

function handleTouchEnd(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipeGesture();
}

function handleSwipeGesture() {
    const threshold = 50; // M√≠nima distancia para considerar swipe
    const swipeDistance = touchEndX - touchStartX;
    
    if (Math.abs(swipeDistance) > threshold) {
        if (swipeDistance > 0) {
            // Desliz√≥ a la derecha -> Ir al ANTERIOR
            if (storeIndex > 0) {
                storeIndex--;
                SoundEngine.move(); // Sonido suave al pasar carta
                updateCoverflow();
            }
        } else {
            // Desliz√≥ a la izquierda -> Ir al SIGUIENTE
            if (storeIndex < storeItemsData.length - 1) {
                storeIndex++;
                SoundEngine.move();
                updateCoverflow();
            }
        }
    }
}

        let confirmCallback = null;
        function showConfirm(title, msg, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = msg;
            confirmCallback = callback;
            document.getElementById('custom-confirm').style.display = 'flex';
            setTimeout(() => document.getElementById('custom-confirm').classList.add('show'), 10);
            
            const btn = document.getElementById('btn-confirm-action');
            btn.onclick = null;
            btn.onclick = function() {
                SoundEngine.click();
                const callbackToRun = confirmCallback; 
                closeCustomConfirm(); 
                if(callbackToRun && typeof callbackToRun === 'function') {
                    callbackToRun(); 
                }
            };
        }
        function closeCustomConfirm() {
            const el = document.getElementById('custom-confirm');
            el.classList.remove('show');
            setTimeout(() => { el.style.display = 'none'; }, 300);
            confirmCallback = null;
        }

        let onAlertClose = null; 
        function customAlert(title, message, type = 'info', callback = null) { 
            const alertEl = document.getElementById('custom-alert'); 
            const iconEl = document.getElementById('alert-icon'); 
            const titleEl = document.getElementById('alert-title'); 
            const messageEl = document.getElementById('alert-message'); 
            onAlertClose = callback;

            iconEl.className = 'alert-icon'; 
            if (type === 'success') iconEl.classList.add('fas', 'fa-check-circle', 'icon-success'); 
            else if (type === 'error') iconEl.classList.add('fas', 'fa-times-circle', 'icon-error'); 
            else iconEl.classList.add('fas', 'fa-info-circle', 'icon-info'); 
            
            iconEl.style.color=type==='success'?'var(--primary)':(type==='error'?'var(--danger)':'var(--secondary)'); 
            titleEl.innerText = title; 
            messageEl.innerText = message; 
            
            alertEl.style.display = 'flex'; 
            setTimeout(() => alertEl.classList.add('show'), 10); 
        }

        function closeCustomAlert() { 
            const alertEl = document.getElementById('custom-alert'); 
            alertEl.classList.remove('show'); 
            setTimeout(() => { 
                alertEl.style.display = 'none';
                if (onAlertClose && typeof onAlertClose === 'function') {
                    onAlertClose();
                    onAlertClose = null; 
                }
            }, 300); 
        }

        function redeem(name, cost, realPrice) { 
            SoundEngine.click();
            const phone = document.getElementById('phone-input').value; 
            if(phone.length !== 8 || !/^\d+$/.test(phone)) { customAlert("Error", "Ingresa un celular de 8 d√≠gitos.", "error"); return; } 
            if(UserState.coins >= cost) { 
                showConfirm("Confirmar Canje", `¬øCanjear ${name} por ${cost} monedas?`, function() {
                    UserState.coins -= cost; 
                    
                    const requestData = {
                        userId: userId,
                        phone: phone,
                        item: name,
                        cost: cost,
                        realPrice: realPrice,
                        status: 'pending',
                        date: Date.now()
                    };
                    db.ref('requests').push(requestData);
                    
                    saveToFirebase(); 
                    loadStore(); 
                    customAlert("¬°Solicitud Enviada!", `Tu recarga llegar√° a ${phone} en un m√°ximo de 30 minutos.`, "success"); 
                });
            } else customAlert("Saldo Insuficiente", `Necesitas ${cost} monedas.`, "error"); 
        }

        function openLifeShop() { document.getElementById('life-modal').style.display = 'flex'; renderUI(); }
        function closeLifeModal() { document.getElementById('life-modal').style.display = 'none'; }
        
        function openReferralModal() { document.getElementById('referral-modal').style.display = 'flex'; }
        function closeReferralModal() { document.getElementById('referral-modal').style.display = 'none'; }
        
        function copyRefId() {
            if(userShortId) {
                navigator.clipboard.writeText(userShortId).then(() => {
                    customAlert("¬°Copiado!", "C√≥digo de referido copiado.", "success");
                });
            }
        }

        function submitReferralCode() {
            if (UserState.hasBeenReferred) {
                customAlert("Ya usado", "Solo puedes canjear un c√≥digo de amigo una vez.", "error");
                return;
            }

            const inputCode = document.getElementById('friend-id-input').value.trim().toUpperCase();
            
            if (!inputCode) { customAlert("Error", "Escribe el ID de tu amigo.", "error"); return; }
            if (inputCode === userShortId) { customAlert("Error", "No puedes usar tu propio c√≥digo.", "error"); return; }
            if (inputCode.length !== 8) { customAlert("Error", "El ID debe tener 8 caracteres.", "error"); return; }

            customAlert("Verificando...", "Buscando amigo...", "info");

            db.ref('users').once('value').then(snapshot => {
                let friendUid = null;
                let friendData = null;

                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const uid = child.key;
                        const shortId = uid.substring(0, 8).toUpperCase();
                        if (shortId === inputCode) {
                            friendUid = uid;
                            friendData = child.val();
                        }
                    });
                }

                closeCustomAlert(); 

                if (friendUid && friendData) {
                    db.ref('users/' + friendUid).transaction(userData => {
                        if (userData) {
                            userData.coins = (userData.coins || 0) + 200;
                            userData.pendingReferralReward = true; 
                        }
                        return userData;
                    });

                    UserState.coins += 100;
                    UserState.hasBeenReferred = true;
                    
                    db.ref('users/' + userId).update({ 
                        coins: UserState.coins, 
                        referredBy: friendUid 
                    });

                    customAlert("¬°√âxito!", "Has ganado 100 monedas y tu amigo 200.", "success");
                    closeReferralModal();
                    renderUI(); 
                } else {
                    customAlert("Error", "C√≥digo de amigo no encontrado.", "error");
                }
            });
        }

        function showGiftAlert() { customAlert(subConfig.giftTitle, subConfig.giftMsg, "success"); }
        function updateLifeShopButtons() { if(UserState.isPremium) return; const isFull = UserState.lives >= GameConfig.MAX_LIVES; document.getElementById('ad-option').classList.toggle('disabled', isFull); document.getElementById('buy-option').classList.toggle('disabled', isFull); }
        
        function checkRegeneration() {
            if (!UserState.isPremium) {
                if (UserState.lives < GameConfig.MAX_LIVES && UserState.lastLifeLossTime === 0) { UserState.lastLifeLossTime = Date.now(); saveToFirebase(); }
                if (UserState.lives < GameConfig.MAX_LIVES && UserState.lastLifeLossTime > 0) {
                    const timePassed = Date.now() - UserState.lastLifeLossTime;
                    if (timePassed >= GameConfig.REFILL_TIME_MS) {
                        const recovered = Math.floor(timePassed / GameConfig.REFILL_TIME_MS);
                        const newLives = Math.min(GameConfig.MAX_LIVES, UserState.lives + recovered);
                        if (newLives > UserState.lives) {
                            UserState.lives = newLives;
                            if (UserState.lives < GameConfig.MAX_LIVES) UserState.lastLifeLossTime = Date.now() - (timePassed % GameConfig.REFILL_TIME_MS);
                            else UserState.lastLifeLossTime = 0;
                            saveToFirebase(); renderUI();
                        }
                    }
                    if (UserState.lives < GameConfig.MAX_LIVES) {
                        const timeLeft = GameConfig.REFILL_TIME_MS - (timePassed % GameConfig.REFILL_TIME_MS);
                        const m = Math.floor(timeLeft / 60000); const s = Math.floor((timeLeft % 60000) / 1000);
                        document.getElementById('life-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                    } else document.getElementById('life-timer').innerText = "";
                } else document.getElementById('life-timer').innerText = "";
            }

            if (UserState.energy < GameConfig.MAX_ENERGY && UserState.lastEnergyRefillTime === 0) { UserState.lastEnergyRefillTime = Date.now(); saveToFirebase(); }
            if (UserState.energy < GameConfig.MAX_ENERGY && UserState.lastEnergyRefillTime > 0) {
                const eTimePassed = Date.now() - UserState.lastEnergyRefillTime;
                if (eTimePassed >= GameConfig.ENERGY_REFILL_MS) {
                    const eRecovered = Math.floor(eTimePassed / GameConfig.ENERGY_REFILL_MS);
                    const newEnergy = Math.min(GameConfig.MAX_ENERGY, UserState.energy + eRecovered);
                    if (newEnergy > UserState.energy) {
                        UserState.energy = newEnergy;
                        if (UserState.energy < GameConfig.MAX_ENERGY) UserState.lastEnergyRefillTime = Date.now() - (eTimePassed % GameConfig.ENERGY_REFILL_MS);
                        else UserState.lastEnergyRefillTime = 0;
                        saveToFirebase(); renderUI();
                    }
                }
                if (UserState.energy < GameConfig.MAX_ENERGY) {
                    const eTimeLeft = GameConfig.ENERGY_REFILL_MS - (eTimePassed % GameConfig.ENERGY_REFILL_MS);
                    const em = Math.floor(eTimeLeft / 60000); const es = Math.floor((eTimeLeft % 60000) / 1000);
                    document.getElementById('energy-timer').innerText = `${em}:${es < 10 ? '0' : ''}${es}`;
                } else document.getElementById('energy-timer').innerText = "";
            } else document.getElementById('energy-timer').innerText = "";
        }

        function watchAd() { 
            if (UserState.lives >= GameConfig.MAX_LIVES) {
                customAlert("Vidas Llenas", "Ya tienes el m√°ximo de vidas.", "info");
                return;
            }
            showConfirm("Ver Anuncio", "Mira un video corto para ganar +1 Vida ‚ù§Ô∏è gratis.", function() {
                window.location.href = "go:S124"; 
            });
        }
        
        function buyLives() { if (UserState.lives >= GameConfig.MAX_LIVES) return; if (UserState.coins >= GameConfig.REFILL_COST) { UserState.coins -= GameConfig.REFILL_COST; UserState.lives = GameConfig.MAX_LIVES; UserState.lastLifeLossTime = 0; saveToFirebase(); renderUI(); customAlert("¬°Vidas recargadas!", `-${GameConfig.REFILL_COST} monedas.`, "success"); closeLifeModal(); } else customAlert("Saldo Insuficiente", `Necesitas ${GameConfig.REFILL_COST} monedas.`, "error"); }
        
        function toggleCodePanel() { const panel = document.getElementById('code-panel'); panel.style.display = panel.style.display === 'block' ? 'none' : 'block'; }
        
        function contactSupport() { const myID = userId ? userId.substring(0, 8).toUpperCase() : "INVITADO"; const phoneNumber = "50247625057"; const message = `Hola Soporte. Me interesa la oferta: ${subConfig.title}. Mi ID es: ${myID}`; window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`, '_blank'); }
        
        function redeemCode() { const input = document.getElementById('activation-code').value.trim().toUpperCase(); if(!input) { customAlert("Error", "Ingresa un c√≥digo.", "error"); return; } db.ref('coupons/' + input).once('value').then((snapshot) => { if (snapshot.exists()) { const couponData = snapshot.val(); if (couponData.used) { customAlert("C√≥digo Usado", "Ya fue utilizado.", "error"); } else { const now = Date.now(); UserState.premiumExpiry = now + (30 * 24 * 60 * 60 * 1000); UserState.isPremium = true; UserState.autoRenew = true; db.ref('coupons/' + input).update({ used: true, usedBy: userId, usedDate: now }); saveToFirebase(); renderUI(); customAlert("¬°Suscripci√≥n Activada!", "Disfruta de tus beneficios.", "success"); closeLifeModal(); } } else { customAlert("Inv√°lido", "Verifica el c√≥digo.", "error"); } }); }
        
        function cancelSubscription() { showConfirm("Cancelar", "¬øCancelar renovaci√≥n autom√°tica?", function() { UserState.autoRenew = false; saveToFirebase(); renderUI(); customAlert("Cancelado", "Ya no renovar√° autom√°ticamente.", "info"); }); }
    </script>
    <script>
        /* --- GESTI√ìN AVANZADA DEL BOT√ìN ATR√ÅS (HISTORIAL) --- */
        window.addEventListener('load', function() { history.pushState(null, null, window.location.href); });

        window.onpopstate = function(event) {
            let handled = false; 

            // 1. ALERTAS Y CONFIRMACIONES (Prioridad M√°xima)
            const alertEl = document.getElementById('custom-alert');
            const confirmEl = document.getElementById('custom-confirm');
            if (alertEl.style.display === 'flex') { closeCustomAlert(); handled = true; }
            else if (confirmEl.style.display === 'flex') { closeCustomConfirm(); handled = true; }

            // 2. MODALES Y PANELES INTERNOS
            if (!handled) {
                // Verificar panel de c√≥digo dentro de Modal Vidas
                const codePanel = document.getElementById('code-panel');
                const lifeModal = document.getElementById('life-modal');
                if (lifeModal && lifeModal.style.display === 'flex' && codePanel.style.display === 'block') {
                    toggleCodePanel(); 
                    handled = true;
                }
            }

            if (!handled) {
                // Cerrar cualquier modal abierto (Config, Resultados, Vidas, Referidos)
                const modals = ['setup-modal', 'game-over-modal', 'life-modal', 'referral-modal'];
                for (let id of modals) {
                    const el = document.getElementById(id);
                    if (el && el.style.display === 'flex') {
                        if(id === 'setup-modal') closeSetupModal();
                        else if(id === 'game-over-modal') closeGameOverModal();
                        else if(id === 'life-modal') closeLifeModal();
                        else if(id === 'referral-modal') closeReferralModal();
                        handled = true;
                        break; 
                    }
                }
            }

            // 3. PANTALLA DE JUEGO (AQU√ç EST√Å LA CORRECCI√ìN)
            if (!handled) {
                const gameScreen = document.getElementById('game-screen');
                if (gameScreen.classList.contains('active')) {
                    // Verificamos la variable global 'gameActive'
                    if (gameActive) {
                        // Si la partida A√öN se est√° jugando -> Preguntar Rendici√≥n
                        quitGame(); 
                    } else {
                        // Si la partida YA TERMIN√ì (est√°s revisando el tablero) -> Mostrar Resultados
                        showGameOverModal();
                    }
                    handled = true;
                }
            }

            // 4. TIENDA -> IR A INICIO
            if (!handled) {
                const storeScreen = document.getElementById('store-screen');
                if (storeScreen.classList.contains('active')) {
                    navTo('home-screen'); 
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    document.querySelector('.nav-item:first-child').classList.add('active'); 
                    handled = true;
                }
            }

            // --- RE-PUSH DEL ESTADO ---
            if (handled) { 
                history.pushState(null, null, window.location.href); 
            } else { 
                console.log("Saliendo de la app..."); 
            }
        };
    </script>
<script>
    window.addEventListener('load', () => {
        const splash = document.getElementById('splash-screen');
        const img = document.getElementById('portada-img'); // Busca la imagen por su ID
        let isHidden = false; // Para evitar que se cierre dos veces

        // Funci√≥n para cerrar el Splash suavemente
        const closeSplash = () => {
            if (isHidden) return; // Si ya se cerr√≥, no hagas nada
            isHidden = true;
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.display = 'none';
            }, 500);
        };

        // L√ìGICA PRINCIPAL
        if (img && img.complete) {
            // A: Si la imagen ya estaba lista (cach√©), espera 2.5s y cierra
            setTimeout(closeSplash, 2500);
        } else if (img) {
            // B: Si la imagen a√∫n no carga, espera a que cargue
            img.onload = () => {
                // Una vez cargada, d√©jala 2 segundos para que se luzca y cierra
                setTimeout(closeSplash, 2000);
            };
            // Si la imagen falla (error de GitHub), cierra inmediatamente
            img.onerror = closeSplash;
        } else {
            // C: Si no encuentra la imagen, cierra a los 2s por seguridad
            setTimeout(closeSplash, 2000);
        }

        // SEGURO DE VIDA: Si pasan 8 segundos y nada ha pasado (internet muy lento),
        // cierra el splash a la fuerza para que el usuario pueda jugar.
        setTimeout(closeSplash, 8000);
    });
</script>
</body>
</html>